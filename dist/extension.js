"use strict";
const mcp_server_1 = require("./mcp-server");
const settings_1 = require("./settings");
const tool_manager_1 = require("./tools/tool-manager");
const editor_adapter_1 = require("./utils/editor-adapter");
let mcpServer = null;
let toolManager;
const messages = {
    'cocos-mcp-server:open-panel'(event) {
        Editor.Panel.open('cocos-mcp-server');
        if (event && event.reply) {
            event.reply();
        }
    },
    async 'cocos-mcp-server:start-server'(event) {
        if (!mcpServer) {
            console.warn('[MCP插件] mcpServer 未初始化，尝试使用默认设置重新创建');
            initializeServer();
        }
        if (!mcpServer) {
            event.reply(new Error('MCP 服务器初始化失败'));
            return;
        }
        try {
            const enabledTools = toolManager.getEnabledTools();
            mcpServer.updateEnabledTools(enabledTools);
            await mcpServer.start();
            event.reply(null, mcpServer.getStatus());
        }
        catch (error) {
            event.reply(error);
        }
    },
    async 'cocos-mcp-server:stop-server'(event) {
        try {
            if (mcpServer) {
                mcpServer.stop();
            }
            event.reply(null, { success: true });
        }
        catch (error) {
            event.reply(error);
        }
    },
    'cocos-mcp-server:get-server-status'(event) {
        try {
            const status = mcpServer ? mcpServer.getStatus() : { running: false, port: 0, clients: 0 };
            const settings = mcpServer ? mcpServer.getSettings() : (0, settings_1.readSettings)();
            event.reply(null, Object.assign(Object.assign({}, status), { settings }));
        }
        catch (error) {
            event.reply(error);
        }
    },
    'cocos-mcp-server:get-server-settings'(event) {
        try {
            event.reply(null, mcpServer ? mcpServer.getSettings() : (0, settings_1.readSettings)());
        }
        catch (error) {
            event.reply(error);
        }
    },
    'cocos-mcp-server:get-settings'(event) {
        try {
            event.reply(null, mcpServer ? mcpServer.getSettings() : (0, settings_1.readSettings)());
        }
        catch (error) {
            event.reply(error);
        }
    },
    'cocos-mcp-server:get-tools-list'(event) {
        try {
            event.reply(null, mcpServer ? mcpServer.getAvailableTools() : []);
        }
        catch (error) {
            event.reply(error);
        }
    },
    'cocos-mcp-server:get-filtered-tools-list'(event) {
        try {
            if (!mcpServer) {
                event.reply(null, []);
                return;
            }
            const enabledTools = toolManager.getEnabledTools();
            mcpServer.updateEnabledTools(enabledTools);
            event.reply(null, mcpServer.getFilteredTools(enabledTools));
        }
        catch (error) {
            event.reply(error);
        }
    },
    async 'cocos-mcp-server:update-settings'(event, settings) {
        if (!settings) {
            event.reply(new Error('无效的服务器设置'));
            return;
        }
        try {
            (0, settings_1.saveSettings)(settings);
            if (mcpServer) {
                mcpServer.stop();
            }
            mcpServer = new mcp_server_1.MCPServer(settings);
            const enabledTools = toolManager.getEnabledTools();
            mcpServer.updateEnabledTools(enabledTools);
            await mcpServer.start();
            event.reply(null, { success: true, settings });
        }
        catch (error) {
            event.reply(error);
        }
    },
    async 'cocos-mcp-server:get-tool-manager-state'(event) {
        try {
            event.reply(null, toolManager.getToolManagerState());
        }
        catch (error) {
            event.reply(error);
        }
    },
    async 'cocos-mcp-server:create-tool-configuration'(event, name, description) {
        try {
            const config = toolManager.createConfiguration(name, description);
            event.reply(null, { success: true, id: config.id, config });
        }
        catch (error) {
            event.reply(error);
        }
    },
    async 'cocos-mcp-server:update-tool-configuration'(event, configId, updates) {
        try {
            event.reply(null, toolManager.updateConfiguration(configId, updates));
        }
        catch (error) {
            event.reply(error);
        }
    },
    async 'cocos-mcp-server:delete-tool-configuration'(event, configId) {
        try {
            toolManager.deleteConfiguration(configId);
            event.reply(null, { success: true });
        }
        catch (error) {
            event.reply(error);
        }
    },
    async 'cocos-mcp-server:set-current-tool-configuration'(event, configId) {
        try {
            toolManager.setCurrentConfiguration(configId);
            event.reply(null, { success: true });
        }
        catch (error) {
            event.reply(error);
        }
    },
    async 'cocos-mcp-server:update-tool-status'(event, category, toolName, enabled) {
        try {
            const currentConfig = toolManager.getCurrentConfiguration();
            if (!currentConfig) {
                throw new Error('没有当前配置');
            }
            toolManager.updateToolStatus(currentConfig.id, category, toolName, enabled);
            if (mcpServer) {
                const enabledTools = toolManager.getEnabledTools();
                mcpServer.updateEnabledTools(enabledTools);
            }
            event.reply(null, { success: true });
        }
        catch (error) {
            event.reply(error);
        }
    },
    async 'cocos-mcp-server:update-tool-status-batch'(event, updates) {
        try {
            const currentConfig = toolManager.getCurrentConfiguration();
            if (!currentConfig) {
                throw new Error('没有当前配置');
            }
            toolManager.updateToolStatusBatch(currentConfig.id, updates);
            if (mcpServer) {
                const enabledTools = toolManager.getEnabledTools();
                mcpServer.updateEnabledTools(enabledTools);
            }
            event.reply(null, { success: true });
        }
        catch (error) {
            event.reply(error);
        }
    },
    async 'cocos-mcp-server:export-tool-configuration'(event, configId) {
        try {
            event.reply(null, { configJson: toolManager.exportConfiguration(configId) });
        }
        catch (error) {
            event.reply(error);
        }
    },
    async 'cocos-mcp-server:import-tool-configuration'(event, configJson) {
        try {
            event.reply(null, toolManager.importConfiguration(configJson));
        }
        catch (error) {
            event.reply(error);
        }
    },
    async 'cocos-mcp-server:get-enabled-tools'(event) {
        try {
            event.reply(null, toolManager.getEnabledTools());
        }
        catch (error) {
            event.reply(error);
        }
    }
};
function initializeServer() {
    toolManager = toolManager || new tool_manager_1.ToolManager();
    const settings = (0, settings_1.readSettings)();
    mcpServer = new mcp_server_1.MCPServer(settings);
    const enabledTools = toolManager.getEnabledTools();
    mcpServer.updateEnabledTools(enabledTools);
    if (settings.autoStart) {
        mcpServer.start().catch((err) => {
            console.error('[MCP插件] 自动启动失败:', err);
        });
    }
}
const extension = {
    load() {
        console.log('[MCP插件] Cocos MCP Server extension loaded');
        (0, editor_adapter_1.ensureEditorAdapters)();
        initializeServer();
    },
    unload() {
        if (mcpServer) {
            mcpServer.stop();
            mcpServer = null;
        }
    },
    messages
};
module.exports = extension;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXh0ZW5zaW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2V4dGVuc2lvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsNkNBQXlDO0FBQ3pDLHlDQUF3RDtBQUV4RCx1REFBbUQ7QUFDbkQsMkRBQThEO0FBRTlELElBQUksU0FBUyxHQUFxQixJQUFJLENBQUM7QUFDdkMsSUFBSSxXQUF3QixDQUFDO0FBSTdCLE1BQU0sUUFBUSxHQUFtQztJQUM3Qyw2QkFBNkIsQ0FBQyxLQUFVO1FBQ3BDLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDdEMsSUFBSSxLQUFLLElBQUksS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ3ZCLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNsQixDQUFDO0lBQ0wsQ0FBQztJQUVELEtBQUssQ0FBQywrQkFBK0IsQ0FBQyxLQUFVO1FBQzVDLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUNiLE9BQU8sQ0FBQyxJQUFJLENBQUMscUNBQXFDLENBQUMsQ0FBQztZQUNwRCxnQkFBZ0IsRUFBRSxDQUFDO1FBQ3ZCLENBQUM7UUFFRCxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDYixLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksS0FBSyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUM7WUFDdkMsT0FBTztRQUNYLENBQUM7UUFFRCxJQUFJLENBQUM7WUFDRCxNQUFNLFlBQVksR0FBRyxXQUFXLENBQUMsZUFBZSxFQUFFLENBQUM7WUFDbkQsU0FBUyxDQUFDLGtCQUFrQixDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQzNDLE1BQU0sU0FBUyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ3hCLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDO1FBQzdDLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFD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LENBQUM7SUFFRCxNQUFNO1FBQ0YsSUFBSSxTQUFTLEVBQUUsQ0FBQztZQUNaLFNBQVMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNqQixTQUFTLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLENBQUM7SUFDTCxDQUFDO0lBRUQsUUFBUTtDQUNYLENBQUM7QUFFRixpQkFBUyxTQUFTLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNQ1BTZXJ2ZXIgfSBmcm9tICcuL21jcC1zZXJ2ZXInO1xuaW1wb3J0IHsgcmVhZFNldHRpbmdzLCBzYXZlU2V0dGluZ3MgfSBmcm9tICcuL3NldHRpbmdzJztcbmltcG9ydCB7IE1DUFNlcnZlclNldHRpbmdzIH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgeyBUb29sTWFuYWdlciB9IGZyb20gJy4vdG9vbHMvdG9vbC1tYW5hZ2VyJztcbmltcG9ydCB7IGVuc3VyZUVkaXRvckFkYXB0ZXJzIH0gZnJvbSAnLi91dGlscy9lZGl0b3ItYWRhcHRlcic7XG5cbmxldCBtY3BTZXJ2ZXI6IE1DUFNlcnZlciB8IG51bGwgPSBudWxsO1xubGV0IHRvb2xNYW5hZ2VyOiBUb29sTWFuYWdlcjtcblxudHlwZSBNZXNzYWdlSGFuZGxlciA9IChldmVudDogYW55LCAuLi5hcmdzOiBhbnlbXSkgPT4gYW55O1xuXG5jb25zdCBtZXNzYWdlczogUmVjb3JkPHN0cmluZywgTWVzc2FnZUhhbmRsZXI+ID0ge1xuICAgICdjb2Nvcy1tY3Atc2VydmVyOm9wZW4tcGFuZWwnKGV2ZW50OiBhbnkpIHtcbiAgICAgICAgRWRpdG9yLlBhbmVsLm9wZW4oJ2NvY29zLW1jcC1zZXJ2ZXInKTtcbiAgICAgICAgaWYgKGV2ZW50ICYmIGV2ZW50LnJlcGx5KSB7XG4gICAgICAgICAgICBldmVudC5yZXBseSgpO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIGFzeW5jICdjb2Nvcy1tY3Atc2VydmVyOnN0YXJ0LXNlcnZlcicoZXZlbnQ6IGFueSkge1xuICAgICAgICBpZiAoIW1jcFNlcnZlcikge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKCdbTUNQ5o+S5Lu2XSBtY3BTZXJ2ZXIg5pyq5Yid5aeL5YyW77yM5bCd6K+V5L2/55So6buY6K6k6K6+572u6YeN5paw5Yib5bu6Jyk7XG4gICAgICAgICAgICBpbml0aWFsaXplU2VydmVyKCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIW1jcFNlcnZlcikge1xuICAgICAgICAgICAgZXZlbnQucmVwbHkobmV3IEVycm9yKCdNQ1Ag5pyN5Yqh5Zmo5Yid5aeL5YyW5aSx6LSlJykpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGVuYWJsZWRUb29scyA9IHRvb2xNYW5hZ2VyLmdldEVuYWJsZWRUb29scygpO1xuICAgICAgICAgICAgbWNwU2VydmVyLnVwZGF0ZUVuYWJsZWRUb29scyhlbmFibGVkVG9vbHMpO1xuICAgICAgICAgICAgYXdhaXQgbWNwU2VydmVyLnN0YXJ0KCk7XG4gICAgICAgICAgICBldmVudC5yZXBseShudWxsLCBtY3BTZXJ2ZXIuZ2V0U3RhdHVzKCkpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgZXZlbnQucmVwbHkoZXJyb3IpO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIGFzeW5jICdjb2Nvcy1tY3Atc2VydmVyOnN0b3Atc2VydmVyJyhldmVudDogYW55KSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAobWNwU2VydmVyKSB7XG4gICAgICAgICAgICAgICAgbWNwU2VydmVyLnN0b3AoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGV2ZW50LnJlcGx5KG51bGwsIHsgc3VjY2VzczogdHJ1ZSB9KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGV2ZW50LnJlcGx5KGVycm9yKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICAnY29jb3MtbWNwLXNlcnZlcjpnZXQtc2VydmVyLXN0YXR1cycoZXZlbnQ6IGFueSkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3Qgc3RhdHVzID0gbWNwU2VydmVyID8gbWNwU2VydmVyLmdldFN0YXR1cygpIDogeyBydW5uaW5nOiBmYWxzZSwgcG9ydDogMCwgY2xpZW50czogMCB9O1xuICAgICAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSBtY3BTZXJ2ZXIgPyBtY3BTZXJ2ZXIuZ2V0U2V0dGluZ3MoKSA6IHJlYWRTZXR0aW5ncygpO1xuICAgICAgICAgICAgZXZlbnQucmVwbHkobnVsbCwge1xuICAgICAgICAgICAgICAgIC4uLnN0YXR1cyxcbiAgICAgICAgICAgICAgICBzZXR0aW5nc1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBldmVudC5yZXBseShlcnJvcik7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgJ2NvY29zLW1jcC1zZXJ2ZXI6Z2V0LXNlcnZlci1zZXR0aW5ncycoZXZlbnQ6IGFueSkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgZXZlbnQucmVwbHkobnVsbCwgbWNwU2VydmVyID8gbWNwU2VydmVyLmdldFNldHRpbmdzKCkgOiByZWFkU2V0dGluZ3MoKSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBldmVudC5yZXBseShlcnJvcik7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgJ2NvY29zLW1jcC1zZXJ2ZXI6Z2V0LXNldHRpbmdzJyhldmVudDogYW55KSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBldmVudC5yZXBseShudWxsLCBtY3BTZXJ2ZXIgPyBtY3BTZXJ2ZXIuZ2V0U2V0dGluZ3MoKSA6IHJlYWRTZXR0aW5ncygpKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGV2ZW50LnJlcGx5KGVycm9yKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICAnY29jb3MtbWNwLXNlcnZlcjpnZXQtdG9vbHMtbGlzdCcoZXZlbnQ6IGFueSkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgZXZlbnQucmVwbHkobnVsbCwgbWNwU2VydmVyID8gbWNwU2VydmVyLmdldEF2YWlsYWJsZVRvb2xzKCkgOiBbXSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBldmVudC5yZXBseShlcnJvcik7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgJ2NvY29zLW1jcC1zZXJ2ZXI6Z2V0LWZpbHRlcmVkLXRvb2xzLWxpc3QnKGV2ZW50OiBhbnkpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGlmICghbWNwU2VydmVyKSB7XG4gICAgICAgICAgICAgICAgZXZlbnQucmVwbHkobnVsbCwgW10pO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgZW5hYmxlZFRvb2xzID0gdG9vbE1hbmFnZXIuZ2V0RW5hYmxlZFRvb2xzKCk7XG4gICAgICAgICAgICBtY3BTZXJ2ZXIudXBkYXRlRW5hYmxlZFRvb2xzKGVuYWJsZWRUb29scyk7XG4gICAgICAgICAgICBldmVudC5yZXBseShudWxsLCBtY3BTZXJ2ZXIuZ2V0RmlsdGVyZWRUb29scyhlbmFibGVkVG9vbHMpKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGV2ZW50LnJlcGx5KGVycm9yKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICBhc3luYyAnY29jb3MtbWNwLXNlcnZlcjp1cGRhdGUtc2V0dGluZ3MnKGV2ZW50OiBhbnksIHNldHRpbmdzOiBNQ1BTZXJ2ZXJTZXR0aW5ncykge1xuICAgICAgICBpZiAoIXNldHRpbmdzKSB7XG4gICAgICAgICAgICBldmVudC5yZXBseShuZXcgRXJyb3IoJ+aXoOaViOeahOacjeWKoeWZqOiuvue9ricpKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBzYXZlU2V0dGluZ3Moc2V0dGluZ3MpO1xuXG4gICAgICAgICAgICBpZiAobWNwU2VydmVyKSB7XG4gICAgICAgICAgICAgICAgbWNwU2VydmVyLnN0b3AoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbWNwU2VydmVyID0gbmV3IE1DUFNlcnZlcihzZXR0aW5ncyk7XG5cbiAgICAgICAgICAgIGNvbnN0IGVuYWJsZWRUb29scyA9IHRvb2xNYW5hZ2VyLmdldEVuYWJsZWRUb29scygpO1xuICAgICAgICAgICAgbWNwU2VydmVyLnVwZGF0ZUVuYWJsZWRUb29scyhlbmFibGVkVG9vbHMpO1xuICAgICAgICAgICAgYXdhaXQgbWNwU2VydmVyLnN0YXJ0KCk7XG5cbiAgICAgICAgICAgIGV2ZW50LnJlcGx5KG51bGwsIHsgc3VjY2VzczogdHJ1ZSwgc2V0dGluZ3MgfSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBldmVudC5yZXBseShlcnJvcik7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgYXN5bmMgJ2NvY29zLW1jcC1zZXJ2ZXI6Z2V0LXRvb2wtbWFuYWdlci1zdGF0ZScoZXZlbnQ6IGFueSkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgZXZlbnQucmVwbHkobnVsbCwgdG9vbE1hbmFnZXIuZ2V0VG9vbE1hbmFnZXJTdGF0ZSgpKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGV2ZW50LnJlcGx5KGVycm9yKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICBhc3luYyAnY29jb3MtbWNwLXNlcnZlcjpjcmVhdGUtdG9vbC1jb25maWd1cmF0aW9uJyhldmVudDogYW55LCBuYW1lOiBzdHJpbmcsIGRlc2NyaXB0aW9uPzogc3RyaW5nKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBjb25maWcgPSB0b29sTWFuYWdlci5jcmVhdGVDb25maWd1cmF0aW9uKG5hbWUsIGRlc2NyaXB0aW9uKTtcbiAgICAgICAgICAgIGV2ZW50LnJlcGx5KG51bGwsIHsgc3VjY2VzczogdHJ1ZSwgaWQ6IGNvbmZpZy5pZCwgY29uZmlnIH0pO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgZXZlbnQucmVwbHkoZXJyb3IpO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIGFzeW5jICdjb2Nvcy1tY3Atc2VydmVyOnVwZGF0ZS10b29sLWNvbmZpZ3VyYXRpb24nKGV2ZW50OiBhbnksIGNvbmZpZ0lkOiBzdHJpbmcsIHVwZGF0ZXM6IGFueSkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgZXZlbnQucmVwbHkobnVsbCwgdG9vbE1hbmFnZXIudXBkYXRlQ29uZmlndXJhdGlvbihjb25maWdJZCwgdXBkYXRlcykpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgZXZlbnQucmVwbHkoZXJyb3IpO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIGFzeW5jICdjb2Nvcy1tY3Atc2VydmVyOmRlbGV0ZS10b29sLWNvbmZpZ3VyYXRpb24nKGV2ZW50OiBhbnksIGNvbmZpZ0lkOiBzdHJpbmcpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHRvb2xNYW5hZ2VyLmRlbGV0ZUNvbmZpZ3VyYXRpb24oY29uZmlnSWQpO1xuICAgICAgICAgICAgZXZlbnQucmVwbHkobnVsbCwgeyBzdWNjZXNzOiB0cnVlIH0pO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgZXZlbnQucmVwbHkoZXJyb3IpO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIGFzeW5jICdjb2Nvcy1tY3Atc2VydmVyOnNldC1jdXJyZW50LXRvb2wtY29uZmlndXJhdGlvbicoZXZlbnQ6IGFueSwgY29uZmlnSWQ6IHN0cmluZykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdG9vbE1hbmFnZXIuc2V0Q3VycmVudENvbmZpZ3VyYXRpb24oY29uZmlnSWQpO1xuICAgICAgICAgICAgZXZlbnQucmVwbHkobnVsbCwgeyBzdWNjZXNzOiB0cnVlIH0pO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgZXZlbnQucmVwbHkoZXJyb3IpO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIGFzeW5jICdjb2Nvcy1tY3Atc2VydmVyOnVwZGF0ZS10b29sLXN0YXR1cycoZXZlbnQ6IGFueSwgY2F0ZWdvcnk6IHN0cmluZywgdG9vbE5hbWU6IHN0cmluZywgZW5hYmxlZDogYm9vbGVhbikge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgY3VycmVudENvbmZpZyA9IHRvb2xNYW5hZ2VyLmdldEN1cnJlbnRDb25maWd1cmF0aW9uKCk7XG4gICAgICAgICAgICBpZiAoIWN1cnJlbnRDb25maWcpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ+ayoeacieW9k+WJjemFjee9ricpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0b29sTWFuYWdlci51cGRhdGVUb29sU3RhdHVzKGN1cnJlbnRDb25maWcuaWQsIGNhdGVnb3J5LCB0b29sTmFtZSwgZW5hYmxlZCk7XG5cbiAgICAgICAgICAgIGlmIChtY3BTZXJ2ZXIpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBlbmFibGVkVG9vbHMgPSB0b29sTWFuYWdlci5nZXRFbmFibGVkVG9vbHMoKTtcbiAgICAgICAgICAgICAgICBtY3BTZXJ2ZXIudXBkYXRlRW5hYmxlZFRvb2xzKGVuYWJsZWRUb29scyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGV2ZW50LnJlcGx5KG51bGwsIHsgc3VjY2VzczogdHJ1ZSB9KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGV2ZW50LnJlcGx5KGVycm9yKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICBhc3luYyAnY29jb3MtbWNwLXNlcnZlcjp1cGRhdGUtdG9vbC1zdGF0dXMtYmF0Y2gnKGV2ZW50OiBhbnksIHVwZGF0ZXM6IGFueVtdKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBjdXJyZW50Q29uZmlnID0gdG9vbE1hbmFnZXIuZ2V0Q3VycmVudENvbmZpZ3VyYXRpb24oKTtcbiAgICAgICAgICAgIGlmICghY3VycmVudENvbmZpZykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcign5rKh5pyJ5b2T5YmN6YWN572uJyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRvb2xNYW5hZ2VyLnVwZGF0ZVRvb2xTdGF0dXNCYXRjaChjdXJyZW50Q29uZmlnLmlkLCB1cGRhdGVzKTtcblxuICAgICAgICAgICAgaWYgKG1jcFNlcnZlcikge1xuICAgICAgICAgICAgICAgIGNvbnN0IGVuYWJsZWRUb29scyA9IHRvb2xNYW5hZ2VyLmdldEVuYWJsZWRUb29scygpO1xuICAgICAgICAgICAgICAgIG1jcFNlcnZlci51cGRhdGVFbmFibGVkVG9vbHMoZW5hYmxlZFRvb2xzKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZXZlbnQucmVwbHkobnVsbCwgeyBzdWNjZXNzOiB0cnVlIH0pO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgZXZlbnQucmVwbHkoZXJyb3IpO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIGFzeW5jICdjb2Nvcy1tY3Atc2VydmVyOmV4cG9ydC10b29sLWNvbmZpZ3VyYXRpb24nKGV2ZW50OiBhbnksIGNvbmZpZ0lkOiBzdHJpbmcpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGV2ZW50LnJlcGx5KG51bGwsIHsgY29uZmlnSnNvbjogdG9vbE1hbmFnZXIuZXhwb3J0Q29uZmlndXJhdGlvbihjb25maWdJZCkgfSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBldmVudC5yZXBseShlcnJvcik7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgYXN5bmMgJ2NvY29zLW1jcC1zZXJ2ZXI6aW1wb3J0LXRvb2wtY29uZmlndXJhdGlvbicoZXZlbnQ6IGFueSwgY29uZmlnSnNvbjogc3RyaW5nKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBldmVudC5yZXBseShudWxsLCB0b29sTWFuYWdlci5pbXBvcnRDb25maWd1cmF0aW9uKGNvbmZpZ0pzb24pKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGV2ZW50LnJlcGx5KGVycm9yKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICBhc3luYyAnY29jb3MtbWNwLXNlcnZlcjpnZXQtZW5hYmxlZC10b29scycoZXZlbnQ6IGFueSkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgZXZlbnQucmVwbHkobnVsbCwgdG9vbE1hbmFnZXIuZ2V0RW5hYmxlZFRvb2xzKCkpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgZXZlbnQucmVwbHkoZXJyb3IpO1xuICAgICAgICB9XG4gICAgfVxufTtcblxuZnVuY3Rpb24gaW5pdGlhbGl6ZVNlcnZlcigpIHtcbiAgICB0b29sTWFuYWdlciA9IHRvb2xNYW5hZ2VyIHx8IG5ldyBUb29sTWFuYWdlcigpO1xuICAgIGNvbnN0IHNldHRpbmdzID0gcmVhZFNldHRpbmdzKCk7XG4gICAgbWNwU2VydmVyID0gbmV3IE1DUFNlcnZlcihzZXR0aW5ncyk7XG5cbiAgICBjb25zdCBlbmFibGVkVG9vbHMgPSB0b29sTWFuYWdlci5nZXRFbmFibGVkVG9vbHMoKTtcbiAgICBtY3BTZXJ2ZXIudXBkYXRlRW5hYmxlZFRvb2xzKGVuYWJsZWRUb29scyk7XG5cbiAgICBpZiAoc2V0dGluZ3MuYXV0b1N0YXJ0KSB7XG4gICAgICAgIG1jcFNlcnZlci5zdGFydCgpLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tNQ1Dmj5Lku7ZdIOiHquWKqOWQr+WKqOWksei0pTonLCBlcnIpO1xuICAgICAgICB9KTtcbiAgICB9XG59XG5cbmNvbnN0IGV4dGVuc2lvbiA9IHtcbiAgICBsb2FkKCkge1xuICAgICAgICBjb25zb2xlLmxvZygnW01DUOaPkuS7tl0gQ29jb3MgTUNQIFNlcnZlciBleHRlbnNpb24gbG9hZGVkJyk7XG4gICAgICAgIGVuc3VyZUVkaXRvckFkYXB0ZXJzKCk7XG4gICAgICAgIGluaXRpYWxpemVTZXJ2ZXIoKTtcbiAgICB9LFxuXG4gICAgdW5sb2FkKCkge1xuICAgICAgICBpZiAobWNwU2VydmVyKSB7XG4gICAgICAgICAgICBtY3BTZXJ2ZXIuc3RvcCgpO1xuICAgICAgICAgICAgbWNwU2VydmVyID0gbnVsbDtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICBtZXNzYWdlc1xufTtcblxuZXhwb3J0ID0gZXh0ZW5zaW9uO1xuIl19