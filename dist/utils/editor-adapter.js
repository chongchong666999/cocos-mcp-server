"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ensureEditorAdapters = ensureEditorAdapters;
function ensureEditorAdapters() {
    const editor = Editor;
    if (!editor.Message) {
        editor.Message = {};
    }
    const callSceneScript = (packageName, methodName, methodArgs = []) => {
        return new Promise((resolve, reject) => {
            if (!editor.Scene || !editor.Scene.callSceneScript) {
                reject(new Error('Editor.Scene.callSceneScript 不可用'));
                return;
            }
            const callback = (err, result) => {
                if (err) {
                    reject(err);
                }
                else {
                    resolve(result);
                }
            };
            try {
                editor.Scene.callSceneScript(packageName, methodName, ...methodArgs, callback);
            }
            catch (error) {
                reject(error);
            }
        });
    };
    if (!editor.Ipc) {
        console.warn('[MCP插件] Editor.Ipc 不存在，部分功能可能无法工作');
        return;
    }
    if (!editor.Message.request) {
        editor.Message.request = function (channel, message, ...args) {
            if (channel === 'scene' && message === 'execute-scene-script') {
                const options = args[0] || {};
                const packageName = options.name || options.package;
                const methodName = options.method;
                const methodArgs = options.args || [];
                return callSceneScript(packageName, methodName, methodArgs);
            }
            if (channel === 'scene' && message === 'query-node-tree') {
                // Cocos Creator 2.4.x 没有提供 scene:query-node-tree 消息，使用场景脚本兼容
                return callSceneScript('cocos-mcp-server', 'getSceneTreeData');
            }
            return new Promise((resolve, reject) => {
                const callback = (err, result) => {
                    if (err) {
                        reject(err);
                    }
                    else {
                        resolve(result);
                    }
                };
                try {
                    editor.Ipc.sendToMain(`${channel}:${message}`, ...args, callback);
                }
                catch (error) {
                    reject(error);
                }
            });
        };
    }
    if (!editor.Message.send) {
        editor.Message.send = function (channel, message, ...args) {
            try {
                editor.Ipc.sendToMain(`${channel}:${message}`, ...args);
            }
            catch (error) {
                console.error('[MCP插件] Message.send 调用失败:', error);
            }
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRpdG9yLWFkYXB0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXRpbHMvZWRpdG9yLWFkYXB0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxvREE2RUM7QUE3RUQsU0FBZ0Isb0JBQW9CO0lBQ2hDLE1BQU0sTUFBTSxHQUFRLE1BQU0sQ0FBQztJQUUzQixJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ2xCLE1BQU0sQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO0lBQ3hCLENBQUM7SUFFRCxNQUFNLGVBQWUsR0FBRyxDQUFDLFdBQW1CLEVBQUUsVUFBa0IsRUFBRSxhQUFvQixFQUFFLEVBQWdCLEVBQUU7UUFDdEcsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNuQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsZUFBZSxFQUFFLENBQUM7Z0JBQ2pELE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDLENBQUM7Z0JBQ3RELE9BQU87WUFDWCxDQUFDO1lBRUQsTUFBTSxRQUFRLEdBQUcsQ0FBQyxHQUFpQixFQUFFLE1BQVcsRUFBRSxFQUFFO2dCQUNoRCxJQUFJLEdBQUcsRUFBRSxDQUFDO29CQUNOLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDaEIsQ0FBQztxQkFBTSxDQUFDO29CQUNKLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDcEIsQ0FBQztZQUNMLENBQUMsQ0FBQztZQUVGLElBQUksQ0FBQztnQkFDRCxNQUFNLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxXQUFXLEVBQUUsVUFBVSxFQUFFLEdBQUcsVUFBVSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQ25GLENBQUM7WUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO2dCQUNiLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNsQixDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDLENBQUM7SUFFRixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ2QsT0FBTyxDQUFDLElBQUksQ0FBQyxtQ0FBbUMsQ0FBQyxDQUFDO1FBQ2xELE9BQU87SUFDWCxDQUFDO0lBRUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDMUIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEdBQUcsVUFBVSxPQUFlLEVBQUUsT0FBZSxFQUFFLEdBQUcsSUFBVztZQUMvRSxJQUFJLE9BQU8sS0FBSyxPQUFPLElBQUksT0FBTyxLQUFLLHNCQUFzQixFQUFFLENBQUM7Z0JBQzVELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQzlCLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxJQUFJLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQztnQkFDcEQsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQztnQkFDbEMsTUFBTSxVQUFVLEdBQVUsT0FBTyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUM7Z0JBQzdDLE9BQU8sZUFBZSxDQUFDLFdBQVcsRUFBRSxVQUFVLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFDaEUsQ0FBQztZQUVELElBQUksT0FBTyxLQUFLLE9BQU8sSUFBSSxPQUFPLEtBQUssaUJBQWlCLEVBQUUsQ0FBQztnQkFDdkQsNkRBQTZEO2dCQUM3RCxPQUFPLGVBQWUsQ0FBQyxrQkFBa0IsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO1lBQ25FLENBQUM7WUFFRCxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO2dCQUNuQyxNQUFNLFFBQVEsR0FBRyxDQUFDLEdBQWlCLEVBQUUsTUFBVyxFQUFFLEVBQUU7b0JBQ2hELElBQUksR0FBRyxFQUFFLENBQUM7d0JBQ04sTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO29CQUNoQixDQUFDO3lCQUFNLENBQUM7d0JBQ0osT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUNwQixDQUFDO2dCQUNMLENBQUMsQ0FBQztnQkFFRixJQUFJLENBQUM7b0JBQ0QsTUFBTSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsR0FBRyxPQUFPLElBQUksT0FBTyxFQUFFLEVBQUUsR0FBRyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7Z0JBQ3RFLENBQUM7Z0JBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztvQkFDYixNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ2xCLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQztJQUNOLENBQUM7SUFFRCxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUN2QixNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksR0FBRyxVQUFVLE9BQWUsRUFBRSxPQUFlLEVBQUUsR0FBRyxJQUFXO1lBQzVFLElBQUksQ0FBQztnQkFDRCxNQUFNLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxHQUFHLE9BQU8sSUFBSSxPQUFPLEVBQUUsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO1lBQzVELENBQUM7WUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO2dCQUNiLE9BQU8sQ0FBQyxLQUFLLENBQUMsNEJBQTRCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDdkQsQ0FBQztRQUNMLENBQUMsQ0FBQztJQUNOLENBQUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGZ1bmN0aW9uIGVuc3VyZUVkaXRvckFkYXB0ZXJzKCkge1xuICAgIGNvbnN0IGVkaXRvcjogYW55ID0gRWRpdG9yO1xuXG4gICAgaWYgKCFlZGl0b3IuTWVzc2FnZSkge1xuICAgICAgICBlZGl0b3IuTWVzc2FnZSA9IHt9O1xuICAgIH1cblxuICAgIGNvbnN0IGNhbGxTY2VuZVNjcmlwdCA9IChwYWNrYWdlTmFtZTogc3RyaW5nLCBtZXRob2ROYW1lOiBzdHJpbmcsIG1ldGhvZEFyZ3M6IGFueVtdID0gW10pOiBQcm9taXNlPGFueT4gPT4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgaWYgKCFlZGl0b3IuU2NlbmUgfHwgIWVkaXRvci5TY2VuZS5jYWxsU2NlbmVTY3JpcHQpIHtcbiAgICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKCdFZGl0b3IuU2NlbmUuY2FsbFNjZW5lU2NyaXB0IOS4jeWPr+eUqCcpKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGNhbGxiYWNrID0gKGVycjogRXJyb3IgfCBudWxsLCByZXN1bHQ6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgZWRpdG9yLlNjZW5lLmNhbGxTY2VuZVNjcmlwdChwYWNrYWdlTmFtZSwgbWV0aG9kTmFtZSwgLi4ubWV0aG9kQXJncywgY2FsbGJhY2spO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgaWYgKCFlZGl0b3IuSXBjKSB7XG4gICAgICAgIGNvbnNvbGUud2FybignW01DUOaPkuS7tl0gRWRpdG9yLklwYyDkuI3lrZjlnKjvvIzpg6jliIblip/og73lj6/og73ml6Dms5Xlt6XkvZwnKTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghZWRpdG9yLk1lc3NhZ2UucmVxdWVzdCkge1xuICAgICAgICBlZGl0b3IuTWVzc2FnZS5yZXF1ZXN0ID0gZnVuY3Rpb24gKGNoYW5uZWw6IHN0cmluZywgbWVzc2FnZTogc3RyaW5nLCAuLi5hcmdzOiBhbnlbXSk6IFByb21pc2U8YW55PiB7XG4gICAgICAgICAgICBpZiAoY2hhbm5lbCA9PT0gJ3NjZW5lJyAmJiBtZXNzYWdlID09PSAnZXhlY3V0ZS1zY2VuZS1zY3JpcHQnKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgb3B0aW9ucyA9IGFyZ3NbMF0gfHwge307XG4gICAgICAgICAgICAgICAgY29uc3QgcGFja2FnZU5hbWUgPSBvcHRpb25zLm5hbWUgfHwgb3B0aW9ucy5wYWNrYWdlO1xuICAgICAgICAgICAgICAgIGNvbnN0IG1ldGhvZE5hbWUgPSBvcHRpb25zLm1ldGhvZDtcbiAgICAgICAgICAgICAgICBjb25zdCBtZXRob2RBcmdzOiBhbnlbXSA9IG9wdGlvbnMuYXJncyB8fCBbXTtcbiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbFNjZW5lU2NyaXB0KHBhY2thZ2VOYW1lLCBtZXRob2ROYW1lLCBtZXRob2RBcmdzKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNoYW5uZWwgPT09ICdzY2VuZScgJiYgbWVzc2FnZSA9PT0gJ3F1ZXJ5LW5vZGUtdHJlZScpIHtcbiAgICAgICAgICAgICAgICAvLyBDb2NvcyBDcmVhdG9yIDIuNC54IOayoeacieaPkOS+myBzY2VuZTpxdWVyeS1ub2RlLXRyZWUg5raI5oGv77yM5L2/55So5Zy65pmv6ISa5pys5YW85a65XG4gICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxTY2VuZVNjcmlwdCgnY29jb3MtbWNwLXNlcnZlcicsICdnZXRTY2VuZVRyZWVEYXRhJyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgY2FsbGJhY2sgPSAoZXJyOiBFcnJvciB8IG51bGwsIHJlc3VsdDogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGVkaXRvci5JcGMuc2VuZFRvTWFpbihgJHtjaGFubmVsfToke21lc3NhZ2V9YCwgLi4uYXJncywgY2FsbGJhY2spO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgaWYgKCFlZGl0b3IuTWVzc2FnZS5zZW5kKSB7XG4gICAgICAgIGVkaXRvci5NZXNzYWdlLnNlbmQgPSBmdW5jdGlvbiAoY2hhbm5lbDogc3RyaW5nLCBtZXNzYWdlOiBzdHJpbmcsIC4uLmFyZ3M6IGFueVtdKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGVkaXRvci5JcGMuc2VuZFRvTWFpbihgJHtjaGFubmVsfToke21lc3NhZ2V9YCwgLi4uYXJncyk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tNQ1Dmj5Lku7ZdIE1lc3NhZ2Uuc2VuZCDosIPnlKjlpLHotKU6JywgZXJyb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgIH1cbn1cbiJdfQ==