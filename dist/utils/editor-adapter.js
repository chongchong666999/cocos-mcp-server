"use strict";
/// <reference path="../../@types/editor.d.ts" />
Object.defineProperty(exports, "__esModule", { value: true });
exports.ensureEditorAdapters = ensureEditorAdapters;
function ensureEditorAdapters() {
    const editor = Editor;
    if (!editor.Message) {
        editor.Message = {};
    }
    const callSceneScript = (packageName, methodName, methodArgs = []) => {
        return new Promise((resolve, reject) => {
            if (!editor.Scene || !editor.Scene.callSceneScript) {
                reject(new Error('Editor.Scene.callSceneScript 不可用'));
                return;
            }
            const callback = (err, result) => {
                if (err) {
                    reject(err);
                }
                else {
                    resolve(result);
                }
            };
            try {
                editor.Scene.callSceneScript(packageName, methodName, ...methodArgs, callback);
            }
            catch (error) {
                reject(error);
            }
        });
    };
    if (!editor.Ipc) {
        console.warn('[MCP插件] Editor.Ipc 不存在，部分功能可能无法工作');
        return;
    }
    if (!editor.Message.request) {
        editor.Message.request = function (channel, message, ...args) {
            if (channel === 'scene' && message === 'execute-scene-script') {
                const options = args[0] || {};
                const packageName = options.name || options.package;
                const methodName = options.method;
                const methodArgs = options.args || [];
                return callSceneScript(packageName, methodName, methodArgs);
            }
            if (channel === 'scene' && message === 'query-node-tree') {
                // Cocos Creator 2.4.x 没有提供 scene:query-node-tree 消息，使用场景脚本兼容
                return callSceneScript('cocos-mcp-server', 'getSceneTreeData');
            }
            return new Promise((resolve, reject) => {
                const callback = (err, result) => {
                    if (err) {
                        reject(err);
                    }
                    else {
                        resolve(result);
                    }
                };
                try {
                    editor.Ipc.sendToMain(`${channel}:${message}`, ...args, callback);
                }
                catch (error) {
                    reject(error);
                }
            });
        };
    }
    if (!editor.Message.send) {
        editor.Message.send = function (channel, message, ...args) {
            try {
                editor.Ipc.sendToMain(`${channel}:${message}`, ...args);
            }
            catch (error) {
                console.error('[MCP插件] Message.send 调用失败:', error);
            }
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRpdG9yLWFkYXB0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXRpbHMvZWRpdG9yLWFkYXB0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLGlEQUFpRDs7QUFFakQsb0RBNkVDO0FBN0VELFNBQWdCLG9CQUFvQjtJQUNoQyxNQUFNLE1BQU0sR0FBUSxNQUFNLENBQUM7SUFFM0IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNsQixNQUFNLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztJQUN4QixDQUFDO0lBRUQsTUFBTSxlQUFlLEdBQUcsQ0FBQyxXQUFtQixFQUFFLFVBQWtCLEVBQUUsYUFBb0IsRUFBRSxFQUFnQixFQUFFO1FBQ3RHLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDbkMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLGVBQWUsRUFBRSxDQUFDO2dCQUNqRCxNQUFNLENBQUMsSUFBSSxLQUFLLENBQUMsa0NBQWtDLENBQUMsQ0FBQyxDQUFDO2dCQUN0RCxPQUFPO1lBQ1gsQ0FBQztZQUVELE1BQU0sUUFBUSxHQUFHLENBQUMsR0FBaUIsRUFBRSxNQUFXLEVBQUUsRUFBRTtnQkFDaEQsSUFBSSxHQUFHLEVBQUUsQ0FBQztvQkFDTixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ2hCLENBQUM7cUJBQU0sQ0FBQztvQkFDSixPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7Z0JBQ3BCLENBQUM7WUFDTCxDQUFDLENBQUM7WUFFRixJQUFJLENBQUM7Z0JBQ0QsTUFBTSxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsV0FBVyxFQUFFLFVBQVUsRUFBRSxHQUFHLFVBQVUsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUNuRixDQUFDO1lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztnQkFDYixNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDbEIsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDO0lBRUYsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUNkLE9BQU8sQ0FBQyxJQUFJLENBQUMsbUNBQW1DLENBQUMsQ0FBQztRQUNsRCxPQUFPO0lBQ1gsQ0FBQztJQUVELElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQzFCLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxHQUFHLFVBQVUsT0FBZSxFQUFFLE9BQWUsRUFBRSxHQUFHLElBQVc7WUFDL0UsSUFBSSxPQUFPLEtBQUssT0FBTyxJQUFJLE9BQU8sS0FBSyxzQkFBc0IsRUFBRSxDQUFDO2dCQUM1RCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUM5QixNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsSUFBSSxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUM7Z0JBQ3BELE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7Z0JBQ2xDLE1BQU0sVUFBVSxHQUFVLE9BQU8sQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDO2dCQUM3QyxPQUFPLGVBQWUsQ0FBQyxXQUFXLEVBQUUsVUFBVSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1lBQ2hFLENBQUM7WUFFRCxJQUFJLE9BQU8sS0FBSyxPQUFPLElBQUksT0FBTyxLQUFLLGlCQUFpQixFQUFFLENBQUM7Z0JBQ3ZELDZEQUE2RDtnQkFDN0QsT0FBTyxlQUFlLENBQUMsa0JBQWtCLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztZQUNuRSxDQUFDO1lBRUQsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtnQkFDbkMsTUFBTSxRQUFRLEdBQUcsQ0FBQyxHQUFpQixFQUFFLE1BQVcsRUFBRSxFQUFFO29CQUNoRCxJQUFJLEdBQUcsRUFBRSxDQUFDO3dCQUNOLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztvQkFDaEIsQ0FBQzt5QkFBTSxDQUFDO3dCQUNKLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztvQkFDcEIsQ0FBQztnQkFDTCxDQUFDLENBQUM7Z0JBRUYsSUFBSSxDQUFDO29CQUNELE1BQU0sQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLEdBQUcsT0FBTyxJQUFJLE9BQU8sRUFBRSxFQUFFLEdBQUcsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO2dCQUN0RSxDQUFDO2dCQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7b0JBQ2IsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNsQixDQUFDO1lBQ0wsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUM7SUFDTixDQUFDO0lBRUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDdkIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEdBQUcsVUFBVSxPQUFlLEVBQUUsT0FBZSxFQUFFLEdBQUcsSUFBVztZQUM1RSxJQUFJLENBQUM7Z0JBQ0QsTUFBTSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsR0FBRyxPQUFPLElBQUksT0FBTyxFQUFFLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztZQUM1RCxDQUFDO1lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztnQkFDYixPQUFPLENBQUMsS0FBSyxDQUFDLDRCQUE0QixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3ZELENBQUM7UUFDTCxDQUFDLENBQUM7SUFDTixDQUFDO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi9AdHlwZXMvZWRpdG9yLmQudHNcIiAvPlxuXG5leHBvcnQgZnVuY3Rpb24gZW5zdXJlRWRpdG9yQWRhcHRlcnMoKSB7XG4gICAgY29uc3QgZWRpdG9yOiBhbnkgPSBFZGl0b3I7XG5cbiAgICBpZiAoIWVkaXRvci5NZXNzYWdlKSB7XG4gICAgICAgIGVkaXRvci5NZXNzYWdlID0ge307XG4gICAgfVxuXG4gICAgY29uc3QgY2FsbFNjZW5lU2NyaXB0ID0gKHBhY2thZ2VOYW1lOiBzdHJpbmcsIG1ldGhvZE5hbWU6IHN0cmluZywgbWV0aG9kQXJnczogYW55W10gPSBbXSk6IFByb21pc2U8YW55PiA9PiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBpZiAoIWVkaXRvci5TY2VuZSB8fCAhZWRpdG9yLlNjZW5lLmNhbGxTY2VuZVNjcmlwdCkge1xuICAgICAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoJ0VkaXRvci5TY2VuZS5jYWxsU2NlbmVTY3JpcHQg5LiN5Y+v55SoJykpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgY2FsbGJhY2sgPSAoZXJyOiBFcnJvciB8IG51bGwsIHJlc3VsdDogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBlZGl0b3IuU2NlbmUuY2FsbFNjZW5lU2NyaXB0KHBhY2thZ2VOYW1lLCBtZXRob2ROYW1lLCAuLi5tZXRob2RBcmdzLCBjYWxsYmFjayk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBpZiAoIWVkaXRvci5JcGMpIHtcbiAgICAgICAgY29uc29sZS53YXJuKCdbTUNQ5o+S5Lu2XSBFZGl0b3IuSXBjIOS4jeWtmOWcqO+8jOmDqOWIhuWKn+iDveWPr+iDveaXoOazleW3peS9nCcpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKCFlZGl0b3IuTWVzc2FnZS5yZXF1ZXN0KSB7XG4gICAgICAgIGVkaXRvci5NZXNzYWdlLnJlcXVlc3QgPSBmdW5jdGlvbiAoY2hhbm5lbDogc3RyaW5nLCBtZXNzYWdlOiBzdHJpbmcsIC4uLmFyZ3M6IGFueVtdKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgICAgIGlmIChjaGFubmVsID09PSAnc2NlbmUnICYmIG1lc3NhZ2UgPT09ICdleGVjdXRlLXNjZW5lLXNjcmlwdCcpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBvcHRpb25zID0gYXJnc1swXSB8fCB7fTtcbiAgICAgICAgICAgICAgICBjb25zdCBwYWNrYWdlTmFtZSA9IG9wdGlvbnMubmFtZSB8fCBvcHRpb25zLnBhY2thZ2U7XG4gICAgICAgICAgICAgICAgY29uc3QgbWV0aG9kTmFtZSA9IG9wdGlvbnMubWV0aG9kO1xuICAgICAgICAgICAgICAgIGNvbnN0IG1ldGhvZEFyZ3M6IGFueVtdID0gb3B0aW9ucy5hcmdzIHx8IFtdO1xuICAgICAgICAgICAgICAgIHJldHVybiBjYWxsU2NlbmVTY3JpcHQocGFja2FnZU5hbWUsIG1ldGhvZE5hbWUsIG1ldGhvZEFyZ3MpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoY2hhbm5lbCA9PT0gJ3NjZW5lJyAmJiBtZXNzYWdlID09PSAncXVlcnktbm9kZS10cmVlJykge1xuICAgICAgICAgICAgICAgIC8vIENvY29zIENyZWF0b3IgMi40Lngg5rKh5pyJ5o+Q5L6bIHNjZW5lOnF1ZXJ5LW5vZGUtdHJlZSDmtojmga/vvIzkvb/nlKjlnLrmma/ohJrmnKzlhbzlrrlcbiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbFNjZW5lU2NyaXB0KCdjb2Nvcy1tY3Atc2VydmVyJywgJ2dldFNjZW5lVHJlZURhdGEnKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBjYWxsYmFjayA9IChlcnI6IEVycm9yIHwgbnVsbCwgcmVzdWx0OiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgZWRpdG9yLklwYy5zZW5kVG9NYWluKGAke2NoYW5uZWx9OiR7bWVzc2FnZX1gLCAuLi5hcmdzLCBjYWxsYmFjayk7XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAoIWVkaXRvci5NZXNzYWdlLnNlbmQpIHtcbiAgICAgICAgZWRpdG9yLk1lc3NhZ2Uuc2VuZCA9IGZ1bmN0aW9uIChjaGFubmVsOiBzdHJpbmcsIG1lc3NhZ2U6IHN0cmluZywgLi4uYXJnczogYW55W10pIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgZWRpdG9yLklwYy5zZW5kVG9NYWluKGAke2NoYW5uZWx9OiR7bWVzc2FnZX1gLCAuLi5hcmdzKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignW01DUOaPkuS7tl0gTWVzc2FnZS5zZW5kIOiwg+eUqOWksei0pTonLCBlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfVxufVxuIl19